#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "π” μ»¤λ°‹ μ „ TypeScript κ²€μ¦ μ‹μ‘..."

# TypeScript μ»΄νμΌ μ²΄ν¬
if ! npm run type-check; then
    echo ""
    echo "β TypeScript μ¤λ¥κ°€ λ°κ²¬λμ—μµλ‹λ‹¤!"
    echo "π’΅ μλ™ μμ •μ„ μ‹λ„ν•©λ‹λ‹¤..."
    
    # Nullish coalescing μλ™ μμ •
    find . -name "*.ts" -o -name "*.tsx" | grep -v node_modules | xargs sed -i 's/!\([a-zA-Z._]*\)\s*??\s*!/!\1 || !/g' 2>/dev/null || true
    find . -name "*.ts" -o -name "*.tsx" | grep -v node_modules | xargs sed -i 's/\([a-zA-Z._]*\)\s*===\s*\(.*\)\s*??\s*\([a-zA-Z._]*\)\s*===\s*\(.*\)/\1 === \2 || \3 === \4/g' 2>/dev/null || true
    
    # λ‹¤μ‹ μ²΄ν¬
    if npm run type-check; then
        echo "β… μλ™ μμ • μ„±κ³µ! λ³€κ²½λ νμΌμ„ μ¤ν…μ΄μ§•μ— μ¶”κ°€ν•©λ‹λ‹¤."
        git add -A
        echo "π‰ μ΄μ  μ»¤λ°‹μ„ μ§„ν–‰ν•©λ‹λ‹¤."
    else
        echo ""
        echo "β μλ™ μμ •μ— μ‹¤ν¨ν–μµλ‹λ‹¤."
        echo "π“ λ‹¤μ νμΌλ“¤μ„ μλ™μΌλ΅ ν™•μΈν•μ„Έμ”:"
        npm run type-check 2>&1 | grep "error TS" | cut -d: -f1 | sort -u || true
        echo ""
        echo "π’» μμ • ν›„ λ‹¤μ‹ μ»¤λ°‹ν•΄μ£Όμ„Έμ”."
        exit 1
    fi
fi

echo "β… TypeScript κ²€μ¦ ν†µκ³Ό!"
echo "π€ μ»¤λ°‹μ„ μ§„ν–‰ν•©λ‹λ‹¤..."