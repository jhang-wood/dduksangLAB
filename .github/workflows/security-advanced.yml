name: ğŸ›¡ï¸ ê³ ê¸‰ ë³´ì•ˆ ìŠ¤ìº” ë° ê²€ì¦

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 3 * * *'  # ë§¤ì¼ ì˜¤í›„ 12ì‹œ (KST)
  workflow_dispatch:
    inputs:
      security_level:
        description: 'ë³´ì•ˆ ê²€ì‚¬ ìˆ˜ì¤€'
        required: true
        default: 'standard'
        type: choice
        options:
          - minimal
          - standard
          - comprehensive
          - penetration-test

env:
  NODE_VERSION: '20'
  SECURITY_SCAN_TIMEOUT: '30'

jobs:
  # OWASP Top 10 ìë™ ìŠ¤ìº”
  owasp-security:
    name: ğŸ” OWASP Top 10 ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    timeout-minutes: 35
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          npm ci --no-audit --no-fund
          npm install --no-save @playwright/test

      - name: ğŸ—ï¸ ë³´ì•ˆ í…ŒìŠ¤íŠ¸ìš© ë¹Œë“œ
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder_key' }}
        run: |
          echo "ğŸ”¨ ë³´ì•ˆ í…ŒìŠ¤íŠ¸ìš© í”„ë¡œë•ì…˜ ë¹Œë“œ..."
          NODE_ENV=production npm run build

      - name: ğŸš€ í…ŒìŠ¤íŠ¸ ì„œë²„ ì‹œì‘
        run: |
          npm start &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          
          echo "â³ ì„œë²„ ì‹œì‘ ëŒ€ê¸°..."
          for i in {1..30}; do
            if curl -s http://localhost:3000 > /dev/null; then
              echo "âœ… ì„œë²„ ì¤€ë¹„ ì™„ë£Œ"
              break
            fi
            sleep 2
          done

      - name: ğŸ›¡ï¸ OWASP ZAP ë² ì´ìŠ¤ë¼ì¸ ìŠ¤ìº”
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -x zap-report.xml -r zap-report.html'
          allow_issue_writing: false

      - name: ğŸ“Š OWASP Top 10 ë§ì¶¤ ê²€ì¦
        run: |
          cat > owasp-security-test.js << 'EOF'
          const { test, expect } = require('@playwright/test');
          
          test.describe('OWASP Top 10 Security Tests', () => {
            
            // A01:2021 â€“ Broken Access Control
            test('Access Control Verification', async ({ page }) => {
              console.log('ğŸ” A01: ì ‘ê·¼ ì œì–´ ê²€ì¦');
              
              // ì¸ì¦ì´ í•„ìš”í•œ í˜ì´ì§€ë“¤ í…ŒìŠ¤íŠ¸
              const protectedRoutes = ['/admin', '/dashboard', '/profile'];
              
              for (const route of protectedRoutes) {
                const response = await page.goto(`http://localhost:3000${route}`, { waitUntil: 'networkidle' });
                
                // ì¸ì¦ë˜ì§€ ì•Šì€ ì ‘ê·¼ ì‹œ ì ì ˆí•œ ë¦¬ë‹¤ì´ë ‰ì…˜ì´ë‚˜ ì—ëŸ¬ ì²˜ë¦¬ í™•ì¸
                if (response.status() === 200) {
                  const currentUrl = page.url();
                  if (!currentUrl.includes('/auth') && !currentUrl.includes('/login')) {
                    console.warn(`âš ï¸ ë³´í˜¸ëœ ë¼ìš°íŠ¸ ${route}ì— ì§ì ‘ ì ‘ê·¼ ê°€ëŠ¥`);
                  } else {
                    console.log(`âœ… ${route}: ì ì ˆíˆ ë³´í˜¸ë¨`);
                  }
                } else if ([401, 403, 302].includes(response.status())) {
                  console.log(`âœ… ${route}: HTTP ${response.status()} - ì ì ˆí•œ ì ‘ê·¼ ì œì–´`);
                }
              }
            });
          
            // A02:2021 â€“ Cryptographic Failures
            test('Cryptographic Implementation', async ({ page }) => {
              console.log('ğŸ” A02: ì•”í˜¸í™” êµ¬í˜„ ê²€ì¦');
              
              await page.goto('http://localhost:3000');
              
              // HTTPS ë¦¬ë‹¤ì´ë ‰ì…˜ í™•ì¸
              const protocol = new URL(page.url()).protocol;
              if (process.env.NODE_ENV === 'production' && protocol !== 'https:') {
                console.warn('âš ï¸ í”„ë¡œë•ì…˜ì—ì„œ HTTPS ì‚¬ìš© ê¶Œì¥');
              }
              
              // ë¯¼ê°í•œ ë°ì´í„° ì €ì¥ì†Œ í™•ì¸
              const localStorage = await page.evaluate(() => Object.keys(localStorage));
              const sessionStorage = await page.evaluate(() => Object.keys(sessionStorage));
              
              const sensitivePatterns = ['password', 'token', 'secret', 'key', 'auth'];
              const suspiciousLocal = localStorage.filter(key => 
                sensitivePatterns.some(pattern => key.toLowerCase().includes(pattern))
              );
              const suspiciousSession = sessionStorage.filter(key => 
                sensitivePatterns.some(pattern => key.toLowerCase().includes(pattern))
              );
              
              if (suspiciousLocal.length > 0) {
                console.warn(`âš ï¸ localStorageì— ë¯¼ê°í•œ ë°ì´í„° ê°€ëŠ¥: ${suspiciousLocal.join(', ')}`);
              }
              if (suspiciousSession.length > 0) {
                console.warn(`âš ï¸ sessionStorageì— ë¯¼ê°í•œ ë°ì´í„° ê°€ëŠ¥: ${suspiciousSession.join(', ')}`);
              }
            });
          
            // A03:2021 â€“ Injection
            test('Injection Attack Prevention', async ({ page }) => {
              console.log('ğŸ” A03: ì¸ì ì…˜ ê³µê²© ë°©ì§€ ê²€ì¦');
              
              await page.goto('http://localhost:3000');
              
              // ê²€ìƒ‰ì´ë‚˜ ì…ë ¥ í¼ì´ ìˆëŠ”ì§€ í™•ì¸
              const inputFields = await page.locator('input[type="text"], input[type="search"], textarea').count();
              
              if (inputFields > 0) {
                const testPayloads = [
                  '<script>alert("XSS")</script>',
                  "'; DROP TABLE users; --",
                  '{{7*7}}',
                  '${7*7}',
                  'javascript:alert("XSS")'
                ];
                
                for (const payload of testPayloads.slice(0, 2)) {
                  try {
                    const firstInput = page.locator('input[type="text"], input[type="search"], textarea').first();
                    await firstInput.fill(payload);
                    await firstInput.press('Enter');
                    await page.waitForTimeout(1000);
                    
                    // í˜ì´ì§€ì—ì„œ ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    const alertHandled = await page.evaluate(() => {
                      return window.hasOwnProperty('alert') && typeof window.alert === 'function';
                    });
                    
                    console.log(`âœ… Payload "${payload.substring(0, 20)}..." ì²˜ë¦¬ë¨`);
                  } catch (error) {
                    console.log(`âœ… ì¸ì ì…˜ ë°©ì–´: ${error.message}`);
                  }
                }
              } else {
                console.log('â„¹ï¸ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ ì…ë ¥ í•„ë“œ ì—†ìŒ');
              }
            });
          
            // A04:2021 â€“ Insecure Design
            test('Secure Design Patterns', async ({ page }) => {
              console.log('ğŸ” A04: ë³´ì•ˆ ì„¤ê³„ íŒ¨í„´ ê²€ì¦');
              
              await page.goto('http://localhost:3000');
              
              // ë³´ì•ˆ í—¤ë” í™•ì¸
              const response = await page.goto('http://localhost:3000');
              const headers = response.headers();
              
              const securityHeaders = {
                'x-frame-options': 'Clickjacking ë°©ì§€',
                'x-content-type-options': 'MIME ìŠ¤ë‹ˆí•‘ ë°©ì§€',
                'x-xss-protection': 'XSS ë°©ì§€',
                'strict-transport-security': 'HTTPS ê°•ì œ',
                'content-security-policy': 'CSP ì •ì±…',
                'referrer-policy': 'Referrer ì •ì±…'
              };
              
              let securityScore = 0;
              for (const [header, description] of Object.entries(securityHeaders)) {
                if (headers[header]) {
                  console.log(`âœ… ${header}: ${description}`);
                  securityScore++;
                } else {
                  console.warn(`âš ï¸ ${header} í—¤ë” ëˆ„ë½: ${description}`);
                }
              }
              
              console.log(`ğŸ“Š ë³´ì•ˆ í—¤ë” ì ìˆ˜: ${securityScore}/${Object.keys(securityHeaders).length}`);
            });
          
            // A05:2021 â€“ Security Misconfiguration
            test('Security Configuration', async ({ page }) => {
              console.log('ğŸ” A05: ë³´ì•ˆ êµ¬ì„± ê²€ì¦');
              
              // ê°œë°œ ëª¨ë“œ í”ì  í™•ì¸
              const response = await page.goto('http://localhost:3000');
              const pageContent = await page.content();
              
              const developmentIndicators = [
                'development',
                'debug',
                'console.log',
                'localhost',
                'test-',
                'demo-'
              ];
              
              const foundIndicators = developmentIndicators.filter(indicator => 
                pageContent.toLowerCase().includes(indicator)
              );
              
              if (foundIndicators.length > 0 && process.env.NODE_ENV === 'production') {
                console.warn(`âš ï¸ í”„ë¡œë•ì…˜ì—ì„œ ê°œë°œ ëª¨ë“œ í”ì : ${foundIndicators.join(', ')}`);
              }
              
              // ì—ëŸ¬ í˜ì´ì§€ ì •ë³´ ë…¸ì¶œ í™•ì¸
              try {
                await page.goto('http://localhost:3000/nonexistent-page');
                const errorContent = await page.content();
                
                if (errorContent.includes('stack') || errorContent.includes('Error:') || errorContent.includes('at ')) {
                  console.warn('âš ï¸ ì—ëŸ¬ í˜ì´ì§€ì—ì„œ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ ë…¸ì¶œ');
                } else {
                  console.log('âœ… ì—ëŸ¬ í˜ì´ì§€ ì •ë³´ ì ì ˆíˆ ì œí•œë¨');
                }
              } catch (error) {
                console.log('âœ… 404 í˜ì´ì§€ ì ì ˆíˆ ì²˜ë¦¬ë¨');
              }
            });
          
            // A06:2021 â€“ Vulnerable and Outdated Components
            test('Component Vulnerability Check', async ({ page }) => {
              console.log('ğŸ” A06: êµ¬ì„± ìš”ì†Œ ì·¨ì•½ì  ê²€ì¦');
              
              await page.goto('http://localhost:3000');
              
              // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „ í™•ì¸
              const libraryVersions = await page.evaluate(() => {
                const versions = {};
                
                // React ë²„ì „ í™•ì¸
                if (window.React) {
                  versions.react = window.React.version;
                }
                
                // jQuery ë²„ì „ í™•ì¸
                if (window.jQuery) {
                  versions.jquery = window.jQuery.fn.jquery;
                }
                
                // ê¸°íƒ€ ì „ì—­ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤
                const globalLibs = ['moment', 'lodash', '_'];
                globalLibs.forEach(lib => {
                  if (window[lib] && window[lib].version) {
                    versions[lib] = window[lib].version;
                  }
                });
                
                return versions;
              });
              
              console.log('ğŸ“š ë°œê²¬ëœ í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬:', libraryVersions);
              
              // package.jsonì—ì„œ ì˜ì¡´ì„± í™•ì¸ì€ ë³„ë„ ë‹¨ê³„ì—ì„œ ìˆ˜í–‰
            });
          
            // A07:2021 â€“ Identification and Authentication Failures
            test('Authentication Security', async ({ page }) => {
              console.log('ğŸ” A07: ì¸ì¦ ë³´ì•ˆ ê²€ì¦');
              
              // ë¡œê·¸ì¸ í˜ì´ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
              const loginResponse = await page.goto('http://localhost:3000/auth/login', { waitUntil: 'networkidle' });
              
              if (loginResponse.status() === 200) {
                // íŒ¨ìŠ¤ì›Œë“œ ì •ì±… í™•ì¸
                const passwordInput = page.locator('input[type="password"]');
                if (await passwordInput.count() > 0) {
                  // ë¸Œë£¨íŠ¸ í¬ìŠ¤ ë°©ì§€ í™•ì¸ (rate limiting)
                  console.log('ğŸ” íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥ í•„ë“œ ë°œê²¬');
                  
                  // íŒ¨ìŠ¤ì›Œë“œ í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€ í™•ì¸
                  const showPasswordToggle = page.locator('button[aria-label*="password"], [data-testid*="password-toggle"]');
                  if (await showPasswordToggle.count() > 0) {
                    console.log('âœ… íŒ¨ìŠ¤ì›Œë“œ í‘œì‹œ/ìˆ¨ê¹€ ê¸°ëŠ¥ ìˆìŒ');
                  }
                  
                  // ìë™ì™„ì„± ì„¤ì • í™•ì¸
                  const autocompleteAttr = await passwordInput.first().getAttribute('autocomplete');
                  if (autocompleteAttr === 'current-password' || autocompleteAttr === 'new-password') {
                    console.log('âœ… ì ì ˆí•œ autocomplete ì„¤ì •');
                  }
                }
                
                // íšŒì›ê°€ì… ë³´ì•ˆ í™•ì¸
                const signupResponse = await page.goto('http://localhost:3000/auth/signup');
                if (signupResponse.status() === 200) {
                  const emailInput = page.locator('input[type="email"]');
                  if (await emailInput.count() > 0) {
                    console.log('âœ… ì´ë©”ì¼ ê¸°ë°˜ ê³„ì • ì‹œìŠ¤í…œ');
                  }
                }
              } else {
                console.log('â„¹ï¸ ì¸ì¦ ì‹œìŠ¤í…œ ì—†ìŒ');
              }
            });
          
            // A10:2021 â€“ Server-Side Request Forgery (SSRF)
            test('SSRF Prevention', async ({ page }) => {
              console.log('ğŸ” A10: SSRF ë°©ì§€ ê²€ì¦');
              
              await page.goto('http://localhost:3000');
              
              // API ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì™¸ë¶€ URL ìš”ì²­ ê¸°ëŠ¥ í™•ì¸
              const apiCalls = [];
              page.on('request', request => {
                if (request.url().includes('/api/')) {
                  apiCalls.push(request.url());
                }
              });
              
              // í˜ì´ì§€ ì¸í„°ë™ì…˜ìœ¼ë¡œ API í˜¸ì¶œ ìœ ë°œ
              await page.waitForTimeout(2000);
              
              if (apiCalls.length > 0) {
                console.log(`ğŸ“¡ API í˜¸ì¶œ ê°ì§€: ${apiCalls.length}ê°œ`);
                console.log('ğŸ’¡ API ì—”ë“œí¬ì¸íŠ¸ì—ì„œ URL ê²€ì¦ í™•ì¸ í•„ìš”');
              } else {
                console.log('â„¹ï¸ API í˜¸ì¶œ ê°ì§€ë˜ì§€ ì•ŠìŒ');
              }
            });
          });
          EOF
          
          npx playwright test owasp-security-test.js --reporter=json:owasp-results.json

      - name: ğŸ§¹ ì„œë²„ ì •ë¦¬
        if: always()
        run: |
          if [ -n "$SERVER_PID" ]; then
            kill $SERVER_PID || true
          fi
          pkill -f "next start" || true

      - name: ğŸ“¤ OWASP ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-security-results
          path: |
            zap-report.xml
            zap-report.html
            owasp-results.json
          retention-days: 30

  # í™˜ê²½ë³€ìˆ˜ ë° ì‹œí¬ë¦¿ ê³ ê¸‰ ê²€ì‚¬
  secrets-advanced-scan:
    name: ğŸ” ê³ ê¸‰ ì‹œí¬ë¦¿ ìŠ¤ìº”
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ” TruffleHog ê³ ê¸‰ ì‹œí¬ë¦¿ ìŠ¤ìº”
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: HEAD~1
          head: HEAD
          extra_args: --no-verification --allow-verification-overlap --json

      - name: ğŸ•µï¸ GitLeaks ì„¤ì • ë° ìŠ¤ìº”
        run: |
          # GitLeaks ì„¤ì • íŒŒì¼ ìƒì„±
          cat > .gitleaks.toml << 'EOF'
          title = "dduksangLAB GitLeaks Config"
          
          [[rules]]
          description = "AWS Access Key ID"
          regex = '''AKIA[0-9A-Z]{16}'''
          tags = ["key", "AWS"]
          
          [[rules]]
          description = "AWS Secret Access Key"
          regex = '''[A-Za-z0-9/\+=]{40}'''
          tags = ["key", "AWS"]
          
          [[rules]]
          description = "Supabase Keys"
          regex = '''eyJ[A-Za-z0-9-_]*\.[A-Za-z0-9-_]*\.[A-Za-z0-9-_]*'''
          tags = ["key", "Supabase", "JWT"]
          
          [[rules]]
          description = "Generic API Keys"
          regex = '''(?i)(api[_-]?key|apikey)['"\s]*[:=]\s*['"][a-z0-9]{16,}['"]'''
          tags = ["key", "API"]
          
          [[rules]]
          description = "Generic Secrets"
          regex = '''(?i)(secret|token|password)['"\s]*[:=]\s*['"][a-z0-9!@#$%^&*()_+\-=\[\]{}|;:,.<>?]{8,}['"]'''
          tags = ["secret"]
          
          [[rules]]
          description = "Database URLs"
          regex = '''(?i)(database_url|db_url|mongo_url)['"\s]*[:=]\s*['"][a-z0-9\-\.:/@]+['"]'''
          tags = ["database"]
          
          [[rules]]
          description = "Private Keys"
          regex = '''-----BEGIN [A-Z]+ PRIVATE KEY-----'''
          tags = ["key", "private"]
          
          # í—ˆìš©í•  íŒŒì¼ë“¤ (false positives ë°©ì§€)
          [allowlist]
          paths = [
            ".gitleaks.toml",
            ".env.example",
            "docs/",
            "README.md"
          ]
          EOF
          
          # GitLeaks ì‹¤í–‰
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_linux_x64.tar.gz | tar -xz
          ./gitleaks detect --config=.gitleaks.toml --report-format=json --report-path=gitleaks-report.json --verbose

      - name: ğŸ” í™˜ê²½ë³€ìˆ˜ ì‚¬ìš© íŒ¨í„´ ë¶„ì„
        run: |
          echo "ğŸ” í™˜ê²½ë³€ìˆ˜ ì‚¬ìš© íŒ¨í„´ ë¶„ì„..."
          
          cat > env-pattern-analyzer.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          function analyzeEnvUsage(dir) {
            const results = {
              envReferences: [],
              potentialLeaks: [],
              hardcodedValues: [],
              configFiles: []
            };
            
            function scanDirectory(currentDir) {
              const items = fs.readdirSync(currentDir);
              
              for (const item of items) {
                const fullPath = path.join(currentDir, item);
                const stat = fs.statSync(fullPath);
                
                // ì œì™¸í•  ë””ë ‰í† ë¦¬ë“¤
                const excludeDirs = ['node_modules', '.next', '.git', 'dist', 'build'];
                if (stat.isDirectory() && !excludeDirs.includes(item)) {
                  scanDirectory(fullPath);
                } else if (stat.isFile()) {
                  scanFile(fullPath);
                }
              }
            }
            
            function scanFile(filePath) {
              const ext = path.extname(filePath);
              const allowedExts = ['.js', '.ts', '.jsx', '.tsx', '.json', '.env'];
              
              if (!allowedExts.includes(ext)) return;
              
              try {
                const content = fs.readFileSync(filePath, 'utf8');
                
                // í™˜ê²½ë³€ìˆ˜ ì°¸ì¡° ì°¾ê¸°
                const envMatches = content.match(/process\.env\.[A-Z_][A-Z0-9_]*/g) || [];
                envMatches.forEach(match => {
                  results.envReferences.push({
                    file: filePath,
                    variable: match,
                    line: content.split('\n').findIndex(line => line.includes(match)) + 1
                  });
                });
                
                // í•˜ë“œì½”ë”©ëœ ê°’ ì°¾ê¸°
                const hardcodedPatterns = [
                  /['"]sk-[a-zA-Z0-9]{20,}['"]/, // OpenAI API keys
                  /['"]pk_live_[a-zA-Z0-9]{24,}['"]/, // Stripe keys
                  /['"]r[a-zA-Z0-9]{33}['"]/, // Reddit keys
                  /['"]xoxb-[a-zA-Z0-9\-]+['"]/, // Slack tokens
                  /['"]ghp_[a-zA-Z0-9]{36}['"]/, // GitHub tokens
                ];
                
                hardcodedPatterns.forEach((pattern, index) => {
                  const matches = content.match(pattern);
                  if (matches) {
                    results.hardcodedValues.push({
                      file: filePath,
                      type: ['OpenAI', 'Stripe', 'Reddit', 'Slack', 'GitHub'][index],
                      match: matches[0].substring(0, 20) + '...'
                    });
                  }
                });
                
                // ì ì¬ì  ëˆ„ì¶œ ì°¾ê¸°
                const potentialLeaks = [
                  /console\.log.*process\.env/g,
                  /alert.*process\.env/g,
                  /document\.write.*process\.env/g
                ];
                
                potentialLeaks.forEach(pattern => {
                  const matches = content.match(pattern);
                  if (matches) {
                    results.potentialLeaks.push({
                      file: filePath,
                      matches: matches
                    });
                  }
                });
                
                // ì„¤ì • íŒŒì¼ë“¤
                if (item.includes('.env') || item.includes('config')) {
                  results.configFiles.push(filePath);
                }
                
              } catch (error) {
                // íŒŒì¼ ì½ê¸° ì‹¤íŒ¨ëŠ” ë¬´ì‹œ
              }
            }
            
            scanDirectory(dir);
            return results;
          }
          
          const results = analyzeEnvUsage('.');
          
          console.log('ğŸ“Š í™˜ê²½ë³€ìˆ˜ ì‚¬ìš© ë¶„ì„ ê²°ê³¼:');
          console.log(`  í™˜ê²½ë³€ìˆ˜ ì°¸ì¡°: ${results.envReferences.length}ê°œ`);
          console.log(`  ì ì¬ì  ëˆ„ì¶œ: ${results.potentialLeaks.length}ê°œ`);
          console.log(`  í•˜ë“œì½”ë”©ëœ ê°’: ${results.hardcodedValues.length}ê°œ`);
          console.log(`  ì„¤ì • íŒŒì¼: ${results.configFiles.length}ê°œ`);
          
          if (results.potentialLeaks.length > 0) {
            console.log('\nâš ï¸ ì ì¬ì  í™˜ê²½ë³€ìˆ˜ ëˆ„ì¶œ:');
            results.potentialLeaks.forEach(leak => {
              console.log(`  ${leak.file}: ${leak.matches.join(', ')}`);
            });
          }
          
          if (results.hardcodedValues.length > 0) {
            console.log('\nğŸš¨ í•˜ë“œì½”ë”©ëœ ë¯¼ê°í•œ ê°’ë“¤:');
            results.hardcodedValues.forEach(hard => {
              console.log(`  ${hard.file}: ${hard.type} - ${hard.match}`);
            });
          }
          
          fs.writeFileSync('env-analysis.json', JSON.stringify(results, null, 2));
          EOF
          
          node env-pattern-analyzer.js

      - name: ğŸ§ª ì˜ì¡´ì„± ì·¨ì•½ì  ê³ ê¸‰ ë¶„ì„
        run: |
          echo "ğŸ” ì˜ì¡´ì„± ì·¨ì•½ì  ê³ ê¸‰ ë¶„ì„..."
          
          # npm audit ìƒì„¸ ë¶„ì„
          npm audit --audit-level=low --json > npm-audit-detailed.json || true
          
          # ì·¨ì•½ì  ë¶„ì„ ìŠ¤í¬ë¦½íŠ¸
          cat > vulnerability-analyzer.js << 'EOF'
          const fs = require('fs');
          
          try {
            const auditData = JSON.parse(fs.readFileSync('npm-audit-detailed.json', 'utf8'));
            
            if (auditData.vulnerabilities) {
              const vulns = Object.entries(auditData.vulnerabilities);
              
              console.log(`ğŸ“Š ì˜ì¡´ì„± ì·¨ì•½ì  ìƒì„¸ ë¶„ì„:`);
              console.log(`  ì´ ì·¨ì•½ì : ${vulns.length}ê°œ`);
              
              const severityCount = { low: 0, moderate: 0, high: 0, critical: 0 };
              const categories = {};
              
              vulns.forEach(([name, vuln]) => {
                const severity = vuln.severity;
                severityCount[severity]++;
                
                const category = vuln.via?.[0]?.title?.split(' ')[0] || 'Unknown';
                categories[category] = (categories[category] || 0) + 1;
              });
              
              console.log(`\nğŸ“ˆ ì‹¬ê°ë„ë³„ ë¶„í¬:`);
              Object.entries(severityCount).forEach(([severity, count]) => {
                if (count > 0) {
                  console.log(`  ${severity}: ${count}ê°œ`);
                }
              });
              
              console.log(`\nğŸ·ï¸ ì¹´í…Œê³ ë¦¬ë³„ ë¶„í¬:`);
              Object.entries(categories).slice(0, 5).forEach(([category, count]) => {
                console.log(`  ${category}: ${count}ê°œ`);
              });
              
              // ì‹¬ê°í•œ ì·¨ì•½ì ë“¤
              const criticalVulns = vulns.filter(([, vuln]) => 
                vuln.severity === 'critical' || vuln.severity === 'high'
              );
              
              if (criticalVulns.length > 0) {
                console.log(`\nğŸš¨ ê¸´ê¸‰ ì²˜ë¦¬ í•„ìš” (Critical/High):`);
                criticalVulns.slice(0, 5).forEach(([name, vuln]) => {
                  console.log(`  ${name}: ${vuln.severity} - ${vuln.via?.[0]?.title || 'No title'}`);
                });
              }
              
              // ê¶Œì¥ì‚¬í•­
              const recommendations = [];
              if (severityCount.critical > 0) {
                recommendations.push('ì¦‰ì‹œ Critical ì·¨ì•½ì  íŒ¨ì¹˜ í•„ìš”');
              }
              if (severityCount.high > 3) {
                recommendations.push('High ì·¨ì•½ì ì´ ë§ìŒ - ìˆœì°¨ì  íŒ¨ì¹˜ ê³„íš ìˆ˜ë¦½');
              }
              if (vulns.length > 50) {
                recommendations.push('ì „ì²´ ì˜ì¡´ì„± ì •ë¦¬ ë° ìµœì‹ í™” í•„ìš”');
              }
              
              if (recommendations.length > 0) {
                console.log(`\nğŸ’¡ ê¶Œì¥ì‚¬í•­:`);
                recommendations.forEach((rec, i) => {
                  console.log(`  ${i + 1}. ${rec}`);
                });
              }
              
            } else {
              console.log('âœ… ë°œê²¬ëœ ì·¨ì•½ì  ì—†ìŒ');
            }
          } catch (error) {
            console.log('â„¹ï¸ npm audit ë°ì´í„° ë¶„ì„ ì‹¤íŒ¨:', error.message);
          }
          EOF
          
          node vulnerability-analyzer.js

      - name: ğŸ“¤ ì‹œí¬ë¦¿ ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secrets-scan-results
          path: |
            gitleaks-report.json
            env-analysis.json
            npm-audit-detailed.json
          retention-days: 30

  # ì½”ë“œ ë³´ì•ˆ ì •ì  ë¶„ì„
  static-security-analysis:
    name: ğŸ“Š ì •ì  ë³´ì•ˆ ë¶„ì„
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ ë³´ì•ˆ ë„êµ¬ ì„¤ì¹˜
        run: |
          npm install --no-save eslint-plugin-security eslint-plugin-react-hooks @typescript-eslint/eslint-plugin
          
      - name: ğŸ” ESLint ë³´ì•ˆ ê·œì¹™ ìŠ¤ìº”
        run: |
          # ë³´ì•ˆ íŠ¹í™” ESLint ì„¤ì • ìƒì„±
          cat > .eslintrc.security.json << 'EOF'
          {
            "extends": ["eslint:recommended"],
            "plugins": ["security", "react-hooks", "@typescript-eslint"],
            "parserOptions": {
              "ecmaVersion": 2021,
              "sourceType": "module",
              "ecmaFeatures": {
                "jsx": true
              }
            },
            "env": {
              "browser": true,
              "node": true,
              "es6": true
            },
            "rules": {
              "security/detect-object-injection": "error",
              "security/detect-non-literal-regexp": "error",
              "security/detect-buffer-noassert": "error",
              "security/detect-child-process": "error",
              "security/detect-disable-mustache-escape": "error",
              "security/detect-eval-with-expression": "error",
              "security/detect-no-csrf-before-method-override": "error",
              "security/detect-non-literal-fs-filename": "error",
              "security/detect-non-literal-require": "error",
              "security/detect-possible-timing-attacks": "error",
              "security/detect-pseudoRandomBytes": "error",
              "security/detect-unsafe-regex": "error",
              "no-eval": "error",
              "no-implied-eval": "error",
              "no-new-func": "error",
              "no-script-url": "error",
              "react-hooks/rules-of-hooks": "error",
              "react-hooks/exhaustive-deps": "warn"
            }
          }
          EOF
          
          # ë³´ì•ˆ ìŠ¤ìº” ì‹¤í–‰
          npx eslint . --config .eslintrc.security.json --ext .js,.jsx,.ts,.tsx --format json > eslint-security.json || true
          
          # ê²°ê³¼ ë¶„ì„
          cat > analyze-security-eslint.js << 'EOF'
          const fs = require('fs');
          
          try {
            const results = JSON.parse(fs.readFileSync('eslint-security.json', 'utf8'));
            
            let totalIssues = 0;
            const ruleStats = {};
            const severityStats = { error: 0, warning: 0 };
            
            results.forEach(file => {
              file.messages.forEach(message => {
                totalIssues++;
                const rule = message.ruleId || 'unknown';
                ruleStats[rule] = (ruleStats[rule] || 0) + 1;
                
                if (message.severity === 2) {
                  severityStats.error++;
                } else if (message.severity === 1) {
                  severityStats.warning++;
                }
              });
            });
            
            console.log('ğŸ“Š ESLint ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼:');
            console.log(`  ì´ ì´ìŠˆ: ${totalIssues}ê°œ`);
            console.log(`  ì—ëŸ¬: ${severityStats.error}ê°œ`);
            console.log(`  ê²½ê³ : ${severityStats.warning}ê°œ`);
            
            if (totalIssues > 0) {
              console.log('\nğŸ” ìƒìœ„ ë³´ì•ˆ ê·œì¹™ ìœ„ë°˜:');
              const sortedRules = Object.entries(ruleStats)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
                
              sortedRules.forEach(([rule, count]) => {
                console.log(`  ${rule}: ${count}ê°œ`);
              });
            }
            
            if (severityStats.error > 0) {
              console.log('\nğŸš¨ ì¦‰ì‹œ ìˆ˜ì • í•„ìš”í•œ ë³´ì•ˆ ì´ìŠˆ:');
              results.forEach(file => {
                const errors = file.messages.filter(m => m.severity === 2);
                if (errors.length > 0) {
                  console.log(`  ${file.filePath}:`);
                  errors.slice(0, 3).forEach(error => {
                    console.log(`    ë¼ì¸ ${error.line}: ${error.message} (${error.ruleId})`);
                  });
                }
              });
            }
            
          } catch (error) {
            console.log('ESLint ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ë¶„ì„ ì‹¤íŒ¨:', error.message);
          }
          EOF
          
          node analyze-security-eslint.js

      - name: ğŸ”’ TypeScript íƒ€ì… ì•ˆì „ì„± ê²€ì¦
        run: |
          echo "ğŸ” TypeScript íƒ€ì… ì•ˆì „ì„± ë³´ì•ˆ ê²€ì¦..."
          
          # íƒ€ì… ì•ˆì „ì„± ê²€ì‚¬
          npx tsc --noEmit --strict > ts-security.log 2>&1 || true
          
          # any íƒ€ì… ì‚¬ìš© ê²€ì‚¬
          find . -name "*.ts" -o -name "*.tsx" | grep -v node_modules | xargs grep -n ": any" > any-types.log || true
          
          echo "ğŸ“Š TypeScript ë³´ì•ˆ ê²€ì¦ ê²°ê³¼:"
          
          if [ -s ts-security.log ]; then
            error_count=$(wc -l < ts-security.log)
            echo "  íƒ€ì… ì˜¤ë¥˜: ${error_count}ê°œ"
            
            if [ "$error_count" -gt 0 ]; then
              echo "\nâš ï¸ ì£¼ìš” íƒ€ì… ì˜¤ë¥˜ë“¤:"
              head -5 ts-security.log
            fi
          else
            echo "  âœ… íƒ€ì… ì˜¤ë¥˜ ì—†ìŒ"
          fi
          
          if [ -s any-types.log ]; then
            any_count=$(wc -l < any-types.log)
            echo "  any íƒ€ì… ì‚¬ìš©: ${any_count}ê°œ"
            
            if [ "$any_count" -gt 10 ]; then
              echo "  âš ï¸ any íƒ€ì… ê³¼ë‹¤ ì‚¬ìš© - íƒ€ì… ì•ˆì „ì„± ìœ„í—˜"
            fi
          else
            echo "  âœ… any íƒ€ì… ì‚¬ìš© ì—†ìŒ"
          fi

      - name: ğŸ“¤ ì •ì  ë¶„ì„ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: static-security-analysis
          path: |
            eslint-security.json
            ts-security.log
            any-types.log
          retention-days: 7

  # ë³´ì•ˆ ì¢…í•© ë¦¬í¬íŠ¸
  security-report:
    name: ğŸ“‹ ë³´ì•ˆ ì¢…í•© ë¦¬í¬íŠ¸
    runs-on: ubuntu-latest
    needs: [owasp-security, secrets-advanced-scan, static-security-analysis]
    if: always()
    
    steps:
      - name: ğŸ“¥ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ“Š ë³´ì•ˆ ì¢…í•© ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          echo "# ğŸ›¡ï¸ dduksangLAB ê³ ê¸‰ ë³´ì•ˆ ìŠ¤ìº” ë¦¬í¬íŠ¸" > security-report.md
          echo "" >> security-report.md
          echo "ìƒì„± ì‹œê°„: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> security-report.md
          echo "ì»¤ë°‹: ${{ github.sha }}" >> security-report.md
          echo "ë¸Œëœì¹˜: ${{ github.ref_name }}" >> security-report.md
          echo "" >> security-report.md
          
          # ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ìš”ì•½
          echo "## ğŸ“Š ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ìš”ì•½" >> security-report.md
          echo "| ë³´ì•ˆ ì˜ì—­ | ìƒíƒœ | ì„¤ëª… |" >> security-report.md
          echo "|----------|------|------|" >> security-report.md
          echo "| OWASP Top 10 | ${{ needs.owasp-security.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ìœ„í—˜' }} | ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë³´ì•ˆ ê¸°ì¤€ |" >> security-report.md
          echo "| ì‹œí¬ë¦¿ ìŠ¤ìº” | ${{ needs.secrets-advanced-scan.result == 'success' && 'âœ… ì•ˆì „' || 'âŒ ëˆ„ì¶œ' }} | í™˜ê²½ë³€ìˆ˜ ë° í•˜ë“œì½”ë”© ê²€ì‚¬ |" >> security-report.md
          echo "| ì •ì  ë¶„ì„ | ${{ needs.static-security-analysis.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ë¬¸ì œ' }} | ì½”ë“œ ë ˆë²¨ ë³´ì•ˆ ë¶„ì„ |" >> security-report.md
          echo "" >> security-report.md
          
          # OWASP ë¶„ì„ ê²°ê³¼
          echo "## ğŸ” OWASP Top 10 ë¶„ì„" >> security-report.md
          if [ -f "artifacts/owasp-security-results/owasp-results.json" ]; then
            echo "### ì£¼ìš” ë°œê²¬ì‚¬í•­" >> security-report.md
            echo "- A01: Broken Access Control ê²€ì¦ ì™„ë£Œ" >> security-report.md
            echo "- A02: Cryptographic Failures ë¶„ì„ ì™„ë£Œ" >> security-report.md
            echo "- A03: Injection ë°©ì–´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ" >> security-report.md
            echo "- A04: Insecure Design ë³´ì•ˆ í—¤ë” ê²€ì¦" >> security-report.md
            echo "- A05: Security Misconfiguration ì„¤ì • ê²€ì¦" >> security-report.md
          else
            echo "- OWASP ìŠ¤ìº” ë°ì´í„° ì—†ìŒ" >> security-report.md
          fi
          echo "" >> security-report.md
          
          # ì‹œí¬ë¦¿ ìŠ¤ìº” ê²°ê³¼
          echo "## ğŸ” ì‹œí¬ë¦¿ ë° í™˜ê²½ë³€ìˆ˜ ê²€ì‚¬" >> security-report.md
          if [ -f "artifacts/secrets-scan-results/env-analysis.json" ]; then
            echo "### í™˜ê²½ë³€ìˆ˜ ì‚¬ìš© í˜„í™©" >> security-report.md
            env_refs=$(jq -r '.envReferences | length' artifacts/secrets-scan-results/env-analysis.json 2>/dev/null || echo "0")
            leaks=$(jq -r '.potentialLeaks | length' artifacts/secrets-scan-results/env-analysis.json 2>/dev/null || echo "0")
            hardcoded=$(jq -r '.hardcodedValues | length' artifacts/secrets-scan-results/env-analysis.json 2>/dev/null || echo "0")
            
            echo "- í™˜ê²½ë³€ìˆ˜ ì°¸ì¡°: ${env_refs}ê°œ" >> security-report.md
            echo "- ì ì¬ì  ëˆ„ì¶œ: ${leaks}ê°œ" >> security-report.md
            echo "- í•˜ë“œì½”ë”©ëœ ê°’: ${hardcoded}ê°œ" >> security-report.md
            
            if [ "$leaks" -gt 0 ] || [ "$hardcoded" -gt 0 ]; then
              echo "- âš ï¸ ì¦‰ì‹œ ê²€í†  í•„ìš”" >> security-report.md
            fi
          else
            echo "- ì‹œí¬ë¦¿ ìŠ¤ìº” ë°ì´í„° ì—†ìŒ" >> security-report.md
          fi
          echo "" >> security-report.md
          
          # ê¶Œì¥ì‚¬í•­
          echo "## ğŸ’¡ ë³´ì•ˆ ê°•í™” ê¶Œì¥ì‚¬í•­" >> security-report.md
          echo "### ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”" >> security-report.md
          echo "1. **Critical/High ì·¨ì•½ì **: ì¦‰ì‹œ íŒ¨ì¹˜ ì ìš©" >> security-report.md
          echo "2. **í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿**: í™˜ê²½ë³€ìˆ˜ë¡œ ì „í™˜" >> security-report.md
          echo "3. **ë³´ì•ˆ í—¤ë”**: ëˆ„ë½ëœ ë³´ì•ˆ í—¤ë” ì¶”ê°€" >> security-report.md
          echo "" >> security-report.md
          echo "### ì§€ì†ì  ê°œì„ " >> security-report.md
          echo "1. **ì˜ì¡´ì„± ê´€ë¦¬**: ì •ê¸°ì  ì—…ë°ì´íŠ¸ ë° ì·¨ì•½ì  ëª¨ë‹ˆí„°ë§" >> security-report.md
          echo "2. **ì½”ë“œ ë¦¬ë·°**: ë³´ì•ˆ ì¤‘ì‹¬ ì½”ë“œ ë¦¬ë·° í”„ë¡œì„¸ìŠ¤" >> security-report.md
          echo "3. **ë³´ì•ˆ í…ŒìŠ¤íŠ¸**: CI/CD íŒŒì´í”„ë¼ì¸ ë³´ì•ˆ í…ŒìŠ¤íŠ¸ í†µí•©" >> security-report.md
          echo "4. **ëª¨ë‹ˆí„°ë§**: ëŸ°íƒ€ì„ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ êµ¬ì¶•" >> security-report.md
          echo "5. **êµìœ¡**: ê°œë°œíŒ€ ë³´ì•ˆ êµìœ¡ ì •ê¸° ì‹¤ì‹œ" >> security-report.md
          echo "" >> security-report.md
          
          # ì»´í”Œë¼ì´ì–¸ìŠ¤ ì²´í¬ë¦¬ìŠ¤íŠ¸
          echo "## âœ… ë³´ì•ˆ ì»´í”Œë¼ì´ì–¸ìŠ¤ ì²´í¬ë¦¬ìŠ¤íŠ¸" >> security-report.md
          echo "- [ ] OWASP Top 10 ëŒ€ì‘ ì™„ë£Œ" >> security-report.md
          echo "- [ ] ëª¨ë“  ì‹œí¬ë¦¿ í™˜ê²½ë³€ìˆ˜í™”" >> security-report.md
          echo "- [ ] CSP í—¤ë” ì ìš©" >> security-report.md
          echo "- [ ] HTTPS ê°•ì œ ì ìš©" >> security-report.md
          echo "- [ ] ì…ë ¥ê°’ ê²€ì¦ ê°•í™”" >> security-report.md
          echo "- [ ] ì—ëŸ¬ ì²˜ë¦¬ ë³´ì•ˆ ê°•í™”" >> security-report.md
          echo "- [ ] ì˜ì¡´ì„± ì·¨ì•½ì  ì œë¡œí™”" >> security-report.md
          echo "- [ ] ì •ê¸° ë³´ì•ˆ ìŠ¤ìº” ìë™í™”" >> security-report.md
          
          cat security-report.md >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ ë³´ì•ˆ ì¢…í•© ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: security-comprehensive-report-${{ github.run_id }}
          path: security-report.md
          retention-days: 90