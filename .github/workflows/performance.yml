name: ğŸ›¡ï¸ 2025 ìŠ¤ë§ˆíŠ¸ ìµœì†Œ CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  # Setup job - ì˜ì¡´ì„± ì„¤ì¹˜ ë° ìºì‹±
  setup:
    name: ğŸ“¦ Setup & Cache
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ—ï¸ ìºì‹œ í‚¤ ìƒì„±
      id: cache-key
      run: echo "key=deps-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ github.run_id }}" >> $GITHUB_OUTPUT
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci --no-audit --no-fund

  # ë³‘ë ¬ ì‹¤í–‰ ì‘ì—…ë“¤
  typescript-check:
    name: ğŸš¨ TypeScript ì²´í¬
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    - name: ğŸ”§ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    - name: ğŸ“¦ ì˜ì¡´ì„± ë³µì›
      run: npm ci --no-audit --no-fund
    - name: ğŸš¨ CRITICAL: TypeScript íƒ€ì… ì²´í¬
      run: npm run type-check

  build-test:
    name: ğŸš¨ ë¹Œë“œ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    - name: ğŸ”§ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    - name: ğŸ“¦ ì˜ì¡´ì„± ë³µì›
      run: npm ci --no-audit --no-fund
    - name: ğŸš¨ CRITICAL: ë¹Œë“œ í…ŒìŠ¤íŠ¸
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        SKIP_ENV_VALIDATION: true
      run: npm run build

  lint-check:
    name: âš ï¸ ESLint ì²´í¬
    runs-on: ubuntu-latest
    needs: setup
    continue-on-error: true # ë¦°íŠ¸ ì—ëŸ¬ëŠ” ê²½ê³ ë§Œ
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    - name: ğŸ”§ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    - name: ğŸ“¦ ì˜ì¡´ì„± ë³µì›
      run: npm ci --no-audit --no-fund
    - name: âš ï¸ ESLint ê¸°ë³¸ ì²´í¬ (ê²½ê³ ë§Œ)
      run: npm run lint -- --quiet --max-warnings 15

  # ìµœì¢… ìƒíƒœ ì²´í¬
  deploy-ready:
    name: âœ… ë°°í¬ ì¤€ë¹„ í™•ì¸
    runs-on: ubuntu-latest
    needs: [typescript-check, build-test, lint-check]
    if: always()
    steps:
    - name: âœ… ë°°í¬ ìƒíƒœ í™•ì¸
      run: |
        echo "ğŸ¯ 2025ë…„ ìŠ¤ë§ˆíŠ¸ 1ì¸ ê°œë°œì í‘œì¤€ ì²´í¬ ì™„ë£Œ"
        echo "âœ… TypeScript: ${{ needs.typescript-check.result }}"  
        echo "âœ… ë¹Œë“œ í…ŒìŠ¤íŠ¸: ${{ needs.build-test.result }}"
        echo "âš ï¸ ESLint: ${{ needs.lint-check.result }} (ê²½ê³  í—ˆìš©)"
        if [ "${{ needs.typescript-check.result }}" != "success" ] || [ "${{ needs.build-test.result }}" != "success" ]; then
          echo "ğŸš« CRITICAL ì²´í¬ ì‹¤íŒ¨ - ë°°í¬ ì¤‘ë‹¨"
          exit 1
        fi
        echo "ğŸš€ Vercel ìë™ ë°°í¬ ì‹œì‘ë¨"
