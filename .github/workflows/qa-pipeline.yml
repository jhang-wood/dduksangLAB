# QA Pipeline - dduksangLAB í’ˆì§ˆ ê²€ì¦ ìë™í™”
name: QA Quality Assurance Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'

jobs:
  # 1ë‹¨ê³„: ê¸°ë³¸ í™˜ê²½ ê²€ì¦
  environment-check:
    name: ğŸŒ Environment Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate required environment variables
        run: |
          echo "ğŸ” í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ê²€ì¦..."
          
          # í´ë¼ì´ì–¸íŠ¸ í™˜ê²½ë³€ìˆ˜ (ì‹œë®¬ë ˆì´ì…˜)
          CLIENT_VARS=("NEXT_PUBLIC_SUPABASE_URL" "NEXT_PUBLIC_SUPABASE_ANON_KEY" "NEXT_PUBLIC_TOSS_CLIENT_KEY")
          
          for var in "${CLIENT_VARS[@]}"; do
            if [ -z "${!var}" ]; then
              echo "âŒ í´ë¼ì´ì–¸íŠ¸ í™˜ê²½ë³€ìˆ˜ ëˆ„ë½: $var"
              echo "::warning::Missing client environment variable: $var"
            else
              echo "âœ… $var ì„¤ì •ë¨"
            fi
          done
          
          echo "í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ì™„ë£Œ"
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://test.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: test-anon-key  
          NEXT_PUBLIC_TOSS_CLIENT_KEY: test-client-key

      - name: Run environment test scenarios
        run: node scripts/qa/test-env-scenarios.js
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://test.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: test-anon-key
          NEXT_PUBLIC_TOSS_CLIENT_KEY: test-client-key
          SUPABASE_SERVICE_ROLE_KEY: test-service-key
          TOSS_SECRET_KEY: test-secret-key
          GEMINI_API_KEY: test-api-key
          CRON_SECRET: test-cron-secret

  # 2ë‹¨ê³„: TypeScript íƒ€ì… ì•ˆì •ì„± ê²€ì¦
  typescript-check:
    name: ğŸ” TypeScript Type Safety
    runs-on: ubuntu-latest
    needs: environment-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript compilation check
        run: |
          echo "ğŸ”§ TypeScript ì»´íŒŒì¼ ê²€ì‚¬..."
          npm run type-check
          
          if [ $? -eq 0 ]; then
            echo "âœ… TypeScript ì»´íŒŒì¼ ì„±ê³µ"
          else
            echo "âŒ TypeScript ì»´íŒŒì¼ ì‹¤íŒ¨"
            exit 1
          fi

      - name: TypeScript strict mode validation
        run: |
          echo "ğŸ”’ TypeScript strict ëª¨ë“œ í™•ì¸..."
          
          # tsconfig.jsonì—ì„œ strict ì„¤ì • í™•ì¸
          STRICT_ENABLED=$(grep -o '"strict":\s*true' tsconfig.json || echo "false")
          
          if [[ "$STRICT_ENABLED" == *"true"* ]]; then
            echo "âœ… TypeScript strict ëª¨ë“œ í™œì„±í™”ë¨"
          else
            echo "âŒ TypeScript strict ëª¨ë“œ ë¹„í™œì„±í™”ë¨"
            echo "::error::TypeScript strict mode must be enabled"
            exit 1
          fi

  # 3ë‹¨ê³„: ESLint ë° ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  code-quality:
    name: ğŸ“‹ Code Quality Check  
    runs-on: ubuntu-latest
    needs: typescript-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ESLint check
        run: |
          echo "ğŸ“‹ ESLint ê²€ì‚¬ ì‹œì‘..."
          npm run lint > eslint-report.txt 2>&1 || true
          
          # ESLint ì—ëŸ¬ ê°œìˆ˜ í™•ì¸
          ERROR_COUNT=$(grep -c "Error:" eslint-report.txt || echo "0")
          WARNING_COUNT=$(grep -c "Warning:" eslint-report.txt || echo "0")
          
          echo "ESLint ê²°ê³¼:"
          echo "  ì—ëŸ¬: $ERROR_COUNT ê°œ"
          echo "  ê²½ê³ : $WARNING_COUNT ê°œ"
          
          # í¬ë¦¬í‹°ì»¬ ì—ëŸ¬ ê°œìˆ˜ ì œí•œ (ì ì§„ì  ê°œì„ )
          if [ "$ERROR_COUNT" -gt 100 ]; then
            echo "âŒ ESLint ì—ëŸ¬ê°€ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤ ($ERROR_COUNT > 100)"
            echo "::warning::Too many ESLint errors: $ERROR_COUNT"
            # í˜„ì¬ëŠ” ê²½ê³ ë¡œë§Œ ì²˜ë¦¬ (ë‚˜ì¤‘ì— exit 1ë¡œ ë³€ê²½)
          else
            echo "âœ… ESLint ì—ëŸ¬ ê°œìˆ˜ í—ˆìš© ë²”ìœ„ ë‚´"
          fi
          
          cat eslint-report.txt

      - name: Console.log usage check
        run: |
          echo "ğŸ” Console.log ì‚¬ìš© ê²€ì‚¬..."
          ./scripts/qa/check-console-usage.sh > console-report.txt 2>&1
          
          # ìŠ¤í¬ë¦½íŠ¸ í´ë” ì œì™¸í•œ console ì‚¬ìš© ê°œìˆ˜ í™•ì¸
          CONSOLE_COUNT=$(grep -r "console\." --include="*.tsx" --include="*.ts" . \
            --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=scripts | wc -l)
          
          echo "Console ì‚¬ìš© í˜„í™©: $CONSOLE_COUNT ê°œ"
          
          # ëª©í‘œ: 50ê°œ ì´í•˜ë¡œ ì¤„ì´ê¸°
          if [ "$CONSOLE_COUNT" -gt 50 ]; then
            echo "âš ï¸  Console.log ì‚¬ìš©ì´ ë§ìŠµë‹ˆë‹¤ ($CONSOLE_COUNT > 50)"
            echo "::warning::Too many console statements: $CONSOLE_COUNT"
          else
            echo "âœ… Console.log ì‚¬ìš© ê°œìˆ˜ ì–‘í˜¸"
          fi
          
          cat console-report.txt

  # 4ë‹¨ê³„: ë¹Œë“œ í…ŒìŠ¤íŠ¸
  build-test:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application (production)
        run: |
          echo "ğŸ—ï¸ production í™˜ê²½ ë¹Œë“œ í…ŒìŠ¤íŠ¸..."
          npm run build
          
          if [ $? -eq 0 ]; then
            echo "âœ… production ë¹Œë“œ ì„±ê³µ"
          else
            echo "âŒ production ë¹Œë“œ ì‹¤íŒ¨"
            exit 1
          fi
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://test.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: test-anon-key
          NEXT_PUBLIC_TOSS_CLIENT_KEY: test-client-key
          SUPABASE_SERVICE_ROLE_KEY: test-service-key
          TOSS_SECRET_KEY: test-secret-key
          GEMINI_API_KEY: test-api-key
          CRON_SECRET: test-cron-secret

      - name: Check build output
        run: |
          echo "ğŸ“¦ ë¹Œë“œ ì¶œë ¥ í™•ì¸..."
          
          if [ -d ".next" ]; then
            echo "âœ… .next ë””ë ‰í† ë¦¬ ìƒì„±ë¨"
            
            # ë¹Œë“œ í¬ê¸° í™•ì¸
            BUILD_SIZE=$(du -sh .next | cut -f1)
            echo "ë¹Œë“œ í¬ê¸°: $BUILD_SIZE"
            
            # ì£¼ìš” íŒŒì¼ ì¡´ì¬ í™•ì¸
            if [ -f ".next/BUILD_ID" ]; then
              echo "âœ… BUILD_ID íŒŒì¼ ì¡´ì¬"
            fi
            
            if [ -d ".next/static" ]; then
              echo "âœ… Static íŒŒì¼ ìƒì„±ë¨"
            fi
          else
            echo "âŒ .next ë””ë ‰í† ë¦¬ ì—†ìŒ"
            exit 1
          fi

  # 5ë‹¨ê³„: ë³´ì•ˆ ê²€ì‚¬
  security-check:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    needs: build-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: npm audit
        run: |
          echo "ğŸ”’ NPM ë³´ì•ˆ ê°ì‚¬..."
          npm audit --audit-level=moderate > audit-report.txt 2>&1 || true
          
          # ê³ ìœ„í—˜ ì·¨ì•½ì  í™•ì¸
          HIGH_VULN=$(grep -c "high" audit-report.txt || echo "0")
          CRITICAL_VULN=$(grep -c "critical" audit-report.txt || echo "0")
          
          echo "ë³´ì•ˆ ê°ì‚¬ ê²°ê³¼:"
          echo "  Critical: $CRITICAL_VULN ê°œ"
          echo "  High: $HIGH_VULN ê°œ"
          
          if [ "$CRITICAL_VULN" -gt 0 ]; then
            echo "âŒ Critical ì·¨ì•½ì  ë°œê²¬"
            echo "::error::Critical vulnerabilities found: $CRITICAL_VULN"
            cat audit-report.txt
            exit 1
          elif [ "$HIGH_VULN" -gt 5 ]; then
            echo "âš ï¸  High ì·¨ì•½ì ì´ ë§ìŠµë‹ˆë‹¤"
            echo "::warning::Many high vulnerabilities found: $HIGH_VULN"
          else
            echo "âœ… ë³´ì•ˆ ê°ì‚¬ í†µê³¼"
          fi

      - name: Check for hardcoded secrets
        run: |
          echo "ğŸ” í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ê²€ì‚¬..."
          
          # ë¯¼ê°í•œ íŒ¨í„´ ê²€ìƒ‰
          SECRET_PATTERNS=("password\s*=" "secret\s*=" "api[_-]?key\s*=" "token\s*=")
          FOUND_SECRETS=0
          
          for pattern in "${SECRET_PATTERNS[@]}"; do
            MATCHES=$(grep -r -i "$pattern" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . \
              --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=.git || echo "")
            
            if [ ! -z "$MATCHES" ]; then
              echo "âš ï¸  íŒ¨í„´ ë°œê²¬: $pattern"
              echo "$MATCHES"
              FOUND_SECRETS=$((FOUND_SECRETS + 1))
            fi
          done
          
          if [ "$FOUND_SECRETS" -gt 0 ]; then
            echo "::warning::Potential hardcoded secrets found"
          else
            echo "âœ… í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ì—†ìŒ"
          fi

  # 6ë‹¨ê³„: ìµœì¢… í’ˆì§ˆ ë¦¬í¬íŠ¸
  quality-report:
    name: ğŸ“Š Quality Report
    runs-on: ubuntu-latest
    needs: [environment-check, typescript-check, code-quality, build-test, security-check]
    if: always()
    steps:
      - name: Generate quality report
        run: |
          echo "ğŸ“Š dduksangLAB í’ˆì§ˆ ê²€ì¦ ì™„ë£Œ ë¦¬í¬íŠ¸"
          echo "=================================="
          
          # ê° ë‹¨ê³„ ê²°ê³¼ í™•ì¸
          ENV_STATUS="${{ needs.environment-check.result }}"
          TS_STATUS="${{ needs.typescript-check.result }}"
          QUALITY_STATUS="${{ needs.code-quality.result }}"
          BUILD_STATUS="${{ needs.build-test.result }}"
          SECURITY_STATUS="${{ needs.security-check.result }}"
          
          echo "ğŸŒ í™˜ê²½ ê²€ì¦: $ENV_STATUS"
          echo "ğŸ” TypeScript: $TS_STATUS"
          echo "ğŸ“‹ ì½”ë“œ í’ˆì§ˆ: $QUALITY_STATUS"  
          echo "ğŸ—ï¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸: $BUILD_STATUS"
          echo "ğŸ”’ ë³´ì•ˆ ê²€ì‚¬: $SECURITY_STATUS"
          
          # ì „ì²´ ì„±ê³µ ì—¬ë¶€ íŒë‹¨
          if [[ "$ENV_STATUS" == "success" && "$TS_STATUS" == "success" && "$BUILD_STATUS" == "success" && "$SECURITY_STATUS" == "success" ]]; then
            echo ""
            echo "ğŸ‰ ëª¨ë“  í’ˆì§ˆ ê²€ì¦ í†µê³¼!"
            echo "âœ… í”„ë¡œë•ì…˜ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ"
          else
            echo ""
            echo "âš ï¸  ì¼ë¶€ í’ˆì§ˆ ê²€ì¦ ì‹¤íŒ¨"
            echo "âŒ ë¬¸ì œ í•´ê²° í›„ ì¬ì‹œë„ í•„ìš”"
          fi
          
          echo ""
          echo "ğŸ“ˆ ê¶Œì¥ ê°œì„ ì‚¬í•­:"
          echo "  â€¢ TypeScript strict ëª¨ë“œ ìœ ì§€"
          echo "  â€¢ ESLint ì—ëŸ¬ ì ì§„ì  ê°ì†Œ"  
          echo "  â€¢ Console.logë¥¼ loggerë¡œ êµì²´"
          echo "  â€¢ ë³´ì•ˆ ì·¨ì•½ì  ì •ê¸° ì ê²€"