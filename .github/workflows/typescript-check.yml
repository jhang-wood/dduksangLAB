name: 🔧 TypeScript 자동 검증

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  typescript-check:
    name: TypeScript 타입 체크
    runs-on: ubuntu-latest
    
    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co' }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-anon-key' }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || 'placeholder-service-key' }}
      NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'https://dduksang.com' }}
      CRON_SECRET: ${{ secrets.CRON_SECRET || 'placeholder-cron-secret' }}
    
    steps:
      - name: 체크아웃
        uses: actions/checkout@v3
        
      - name: Node.js 설정
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: 의존성 설치
        run: npm ci --ignore-scripts
        
      - name: TypeScript 컴파일 체크
        run: |
          echo "🔍 TypeScript 컴파일 체크 시작..."
          if ! npm run type-check; then
            echo "❌ TypeScript 오류 발견!"
            echo "::error::TypeScript 컴파일 오류가 있습니다. 수정 후 다시 커밋해주세요."
            exit 1
          fi
          echo "✅ TypeScript 컴파일 성공!"
          
      - name: ESLint 체크 (선택적)
        run: |
          echo "🔍 ESLint 체크 시작..."
          npm run lint || echo "⚠️ ESLint 경고가 있지만 계속 진행합니다."
          
      - name: 빌드 테스트
        run: |
          echo "🏗️ 빌드 테스트 시작..."
          npm run build
          echo "✅ 빌드 성공!"

  # TypeScript 오류 자동 수정 (실패시에만 실행)
  auto-fix:
    name: TypeScript 오류 자동 수정
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'push'
    needs: [typescript-check]
    
    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co' }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-anon-key' }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || 'placeholder-service-key' }}
      NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'https://dduksang.com' }}
      CRON_SECRET: ${{ secrets.CRON_SECRET || 'placeholder-cron-secret' }}
    
    steps:
      - name: 체크아웃
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Node.js 설정
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: 의존성 설치
        run: npm ci --ignore-scripts
        
      - name: 자동 수정 시도
        run: |
          echo "🔧 TypeScript 오류 자동 수정 시도..."
          
          # Nullish coalescing 패턴 자동 수정
          find . -name "*.ts" -o -name "*.tsx" | grep -v node_modules | xargs sed -i 's/!\([a-zA-Z._]*\)\s*??\s*!/!\1 \|\| !/g'
          find . -name "*.ts" -o -name "*.tsx" | grep -v node_modules | xargs sed -i 's/\([a-zA-Z._]*\)\s*===\s*\(.*\)\s*??\s*\([a-zA-Z._]*\)\s*===\s*\(.*\)/\1 === \2 || \3 === \4/g'
          
          # 다시 타입 체크
          if npm run type-check; then
            echo "✅ 자동 수정 성공!"
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add -A
            git commit -m "🤖 자동 수정: TypeScript 오류 해결" || echo "변경사항 없음"
            git push || echo "푸시 실패"
          else
            echo "❌ 자동 수정 실패 - 수동 수정 필요"
            exit 1
          fi