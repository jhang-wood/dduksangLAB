name: ğŸ”§ TypeScript ìë™ ê²€ì¦

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  typescript-check:
    name: TypeScript íƒ€ì… ì²´í¬
    runs-on: ubuntu-latest
    
    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co' }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-anon-key' }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || 'placeholder-service-key' }}
      NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'https://dduksang.com' }}
      CRON_SECRET: ${{ secrets.CRON_SECRET || 'placeholder-cron-secret' }}
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
        
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --ignore-scripts
        
      - name: TypeScript ì»´íŒŒì¼ ì²´í¬
        run: |
          echo "ğŸ” TypeScript ì»´íŒŒì¼ ì²´í¬ ì‹œì‘..."
          if ! npm run type-check; then
            echo "âŒ TypeScript ì˜¤ë¥˜ ë°œê²¬!"
            echo "::error::TypeScript ì»´íŒŒì¼ ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ë‹¤ì‹œ ì»¤ë°‹í•´ì£¼ì„¸ìš”."
            exit 1
          fi
          echo "âœ… TypeScript ì»´íŒŒì¼ ì„±ê³µ!"
          
      - name: ESLint ì²´í¬ (ì„ íƒì )
        run: |
          echo "ğŸ” ESLint ì²´í¬ ì‹œì‘..."
          npm run lint || echo "âš ï¸ ESLint ê²½ê³ ê°€ ìˆì§€ë§Œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤."
          
      - name: ë¹Œë“œ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ—ï¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
          npm run build
          echo "âœ… ë¹Œë“œ ì„±ê³µ!"

  # TypeScript ì˜¤ë¥˜ ìë™ ìˆ˜ì • (ì‹¤íŒ¨ì‹œì—ë§Œ ì‹¤í–‰)
  auto-fix:
    name: TypeScript ì˜¤ë¥˜ ìë™ ìˆ˜ì •
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'push'
    needs: [typescript-check]
    
    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co' }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-anon-key' }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || 'placeholder-service-key' }}
      NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'https://dduksang.com' }}
      CRON_SECRET: ${{ secrets.CRON_SECRET || 'placeholder-cron-secret' }}
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --ignore-scripts
        
      - name: ìë™ ìˆ˜ì • ì‹œë„
        run: |
          echo "ğŸ”§ TypeScript ì˜¤ë¥˜ ìë™ ìˆ˜ì • ì‹œë„..."
          
          # Nullish coalescing íŒ¨í„´ ìë™ ìˆ˜ì •
          find . -name "*.ts" -o -name "*.tsx" | grep -v node_modules | xargs sed -i 's/!\([a-zA-Z._]*\)\s*??\s*!/!\1 \|\| !/g'
          find . -name "*.ts" -o -name "*.tsx" | grep -v node_modules | xargs sed -i 's/\([a-zA-Z._]*\)\s*===\s*\(.*\)\s*??\s*\([a-zA-Z._]*\)\s*===\s*\(.*\)/\1 === \2 || \3 === \4/g'
          
          # ë‹¤ì‹œ íƒ€ì… ì²´í¬
          if npm run type-check; then
            echo "âœ… ìë™ ìˆ˜ì • ì„±ê³µ!"
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add -A
            git commit -m "ğŸ¤– ìë™ ìˆ˜ì •: TypeScript ì˜¤ë¥˜ í•´ê²°" || echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
            git push || echo "í‘¸ì‹œ ì‹¤íŒ¨"
          else
            echo "âŒ ìë™ ìˆ˜ì • ì‹¤íŒ¨ - ìˆ˜ë™ ìˆ˜ì • í•„ìš”"
            exit 1
          fi