name: ğŸ”” í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì‹œìŠ¤í…œ

on:
  # ì¼ì¼ ìƒíƒœ ë³´ê³ ì„œ (ì˜¤ì „ 9ì‹œ)
  schedule:
    - cron: '0 0 * * *'  # UTC 00:00 = KST 09:00
  
  # ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼ ì•Œë¦¼
  workflow_run:
    workflows: ['CI/CD Pipeline', 'Deploy to Vercel', 'Security Scan']
    types: [completed]
  
  # Merge Queue ì´ë²¤íŠ¸
  merge_group:
    types: [checks_requested]
  
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      message_type:
        description: 'ì•Œë¦¼ ìœ í˜•'
        required: true
        default: 'manual'
        type: choice
        options:
          - manual
          - daily_report
          - test_notification
      custom_message:
        description: 'ì‚¬ìš©ì ì •ì˜ ë©”ì‹œì§€'
        required: false
        type: string

env:
  TZ: 'Asia/Seoul'

jobs:
  daily-report:
    name: ğŸ“Š ì¼ì¼ ìƒíƒœ ë³´ê³ ì„œ
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.message_type == 'daily_report')
    
    steps:
      - name: ğŸ” ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“ˆ ì €ì¥ì†Œ í†µê³„ ìˆ˜ì§‘
        id: stats
        run: |
          # ìµœê·¼ 24ì‹œê°„ ì»¤ë°‹ ìˆ˜
          COMMITS_TODAY=$(git log --since="24 hours ago" --oneline | wc -l)
          
          # ì´ ì»¤ë°‹ ìˆ˜
          TOTAL_COMMITS=$(git rev-list --all --count)
          
          # ìµœì‹  ì»¤ë°‹ ì •ë³´
          LATEST_COMMIT=$(git log -1 --pretty=format:"%s (%an)")
          
          # ë¸Œëœì¹˜ ìˆ˜
          BRANCHES=$(git branch -r | wc -l)
          
          # íŒŒì¼ ìˆ˜ (ì½”ë“œ íŒŒì¼ë§Œ)
          CODE_FILES=$(find . -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.json" \) ! -path "./node_modules/*" ! -path "./.next/*" | wc -l)
          
          # GitHub Issues ë° PR í†µê³„
          OPEN_ISSUES=$(gh issue list --state open --json number | jq length)
          OPEN_PRS=$(gh pr list --state open --json number | jq length)
          
          echo "commits_today=$COMMITS_TODAY" >> $GITHUB_OUTPUT
          echo "total_commits=$TOTAL_COMMITS" >> $GITHUB_OUTPUT
          echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          echo "code_files=$CODE_FILES" >> $GITHUB_OUTPUT
          echo "open_issues=$OPEN_ISSUES" >> $GITHUB_OUTPUT
          echo "open_prs=$OPEN_PRS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ¥ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
        id: health
        run: |
          # Vercel ë°°í¬ ìƒíƒœ í™•ì¸ (API í˜¸ì¶œ)
          DEPLOYMENT_STATUS="âœ… ì •ìƒ"
          
          # ì›¹ì‚¬ì´íŠ¸ ì‘ë‹µ ì‹œê°„ ì¸¡ì •
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' https://dduksanglab.vercel.app || echo "0")
          RESPONSE_TIME_MS=$(echo "$RESPONSE_TIME * 1000" | bc)
          
          echo "deployment_status=$DEPLOYMENT_STATUS" >> $GITHUB_OUTPUT
          echo "response_time=${RESPONSE_TIME_MS}ms" >> $GITHUB_OUTPUT

      - name: ğŸ“… ë‚ ì§œ ë° ì‹œê°„ ì„¤ì •
        id: datetime
        run: |
          CURRENT_DATE=$(TZ=Asia/Seoul date '+%Yë…„ %mì›” %dì¼')
          CURRENT_TIME=$(TZ=Asia/Seoul date '+%Hì‹œ %Më¶„')
          echo "date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "time=$CURRENT_TIME" >> $GITHUB_OUTPUT

      - name: ğŸ“± ì¼ì¼ ë³´ê³ ì„œ ì „ì†¡
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸŒ… **ë–¡ìƒì—°êµ¬ì†Œ ì¼ì¼ ë³´ê³ ì„œ**
            ğŸ“… ${{ steps.datetime.outputs.date }} ${{ steps.datetime.outputs.time }}
            
            ğŸ“Š **ê°œë°œ í˜„í™©**
            â€¢ ì˜¤ëŠ˜ ì»¤ë°‹: ${{ steps.stats.outputs.commits_today }}ê°œ
            â€¢ ì´ ì»¤ë°‹ ìˆ˜: ${{ steps.stats.outputs.total_commits }}ê°œ
            â€¢ ì½”ë“œ íŒŒì¼: ${{ steps.stats.outputs.code_files }}ê°œ
            â€¢ ë¸Œëœì¹˜ ìˆ˜: ${{ steps.stats.outputs.branches }}ê°œ
            
            ğŸ”§ **ìµœì‹  ì‘ì—…**
            ${{ steps.stats.outputs.latest_commit }}
            
            ğŸ—ï¸ **í”„ë¡œì íŠ¸ ìƒíƒœ**
            â€¢ ì—´ë¦° ì´ìŠˆ: ${{ steps.stats.outputs.open_issues }}ê°œ
            â€¢ ì—´ë¦° PR: ${{ steps.stats.outputs.open_prs }}ê°œ
            
            ğŸš€ **ë°°í¬ ìƒíƒœ**
            â€¢ ìƒíƒœ: ${{ steps.health.outputs.deployment_status }}
            â€¢ ì‘ë‹µ ì‹œê°„: ${{ steps.health.outputs.response_time }}
            â€¢ URL: https://dduksanglab.vercel.app
            
            ---
            ğŸ’¡ ë¬¸ì œê°€ ìˆë‹¤ë©´ ì¦‰ì‹œ í™•ì¸í•˜ì„¸ìš”!
          format: markdown

  build-failure-alert:
    name: âŒ ë¹Œë“œ ì‹¤íŒ¨ ì•Œë¦¼
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure'
    
    steps:
      - name: ğŸš¨ ë¹Œë“œ ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸš¨ **ë¹Œë“œ ì‹¤íŒ¨ ì•Œë¦¼**
            
            âŒ **ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš°**: ${{ github.event.workflow_run.name }}
            ğŸ”— **ì»¤ë°‹**: ${{ github.event.workflow_run.head_commit.message }}
            ğŸ‘¤ **ì‘ì„±ì**: ${{ github.event.workflow_run.head_commit.author.name }}
            ğŸŒ¿ **ë¸Œëœì¹˜**: ${{ github.event.workflow_run.head_branch }}
            
            ğŸ“‹ **ì„¸ë¶€ì‚¬í•­**:
            â€¢ ì‹¤í–‰ ID: ${{ github.event.workflow_run.id }}
            â€¢ ì‹œì‘ ì‹œê°„: ${{ github.event.workflow_run.created_at }}
            â€¢ ì¢…ë£Œ ì‹œê°„: ${{ github.event.workflow_run.updated_at }}
            
            ğŸ” **ë¡œê·¸ í™•ì¸**: 
            ${{ github.event.workflow_run.html_url }}
            
            ---
            âš¡ ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!
          format: markdown

  deployment-success:
    name: âœ… ë°°í¬ ì„±ê³µ ì•Œë¦¼
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && contains(github.event.workflow_run.name, 'Deploy')
    
    steps:
      - name: ğŸ‰ ë°°í¬ ì„±ê³µ ì•Œë¦¼ ì „ì†¡
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸ‰ **ë°°í¬ ì™„ë£Œ!**
            
            âœ… **ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë¨**: ${{ github.event.workflow_run.name }}
            ğŸ”— **ì»¤ë°‹**: ${{ github.event.workflow_run.head_commit.message }}
            ğŸ‘¤ **ì‘ì„±ì**: ${{ github.event.workflow_run.head_commit.author.name }}
            ğŸŒ¿ **ë¸Œëœì¹˜**: ${{ github.event.workflow_run.head_branch }}
            
            ğŸš€ **ë°°í¬ ì •ë³´**:
            â€¢ ë°°í¬ ì‹œê°„: ${{ github.event.workflow_run.updated_at }}
            â€¢ ì›¹ì‚¬ì´íŠ¸: https://dduksanglab.vercel.app
            
            ğŸ“Š **í™•ì¸ì‚¬í•­**:
            â€¢ ì›¹ì‚¬ì´íŠ¸ê°€ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”
            â€¢ ìƒˆë¡œìš´ ê¸°ëŠ¥ì´ ì˜¬ë°”ë¥´ê²Œ ë™ì‘í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”
            
            ---
            ğŸ¯ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
          format: markdown

  manual-notification:
    name: ğŸ“¢ ìˆ˜ë™ ì•Œë¦¼
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.message_type == 'manual'
    
    steps:
      - name: ğŸ“¤ ì‚¬ìš©ì ì •ì˜ ì•Œë¦¼ ì „ì†¡
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸ“¢ **ìˆ˜ë™ ì•Œë¦¼**
            
            ğŸ’¬ **ë©”ì‹œì§€**: 
            ${{ github.event.inputs.custom_message || 'ì‚¬ìš©ì ì •ì˜ ì•Œë¦¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.' }}
            
            ğŸ“… **ì „ì†¡ ì‹œê°„**: $(TZ=Asia/Seoul date '+%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„')
            ğŸ‘¤ **ì „ì†¡ì**: ${{ github.actor }}
            
            ---
            ğŸ”” GitHub Actionsì—ì„œ ì „ì†¡ëœ ì•Œë¦¼ì…ë‹ˆë‹¤.
          format: markdown

  test-notification:
    name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì•Œë¦¼
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.message_type == 'test_notification'
    
    steps:
      - name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸ§ª **í…”ë ˆê·¸ë¨ ë´‡ í…ŒìŠ¤íŠ¸**
            
            âœ… í…”ë ˆê·¸ë¨ ì•Œë¦¼ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!
            
            ğŸ“‹ **í…ŒìŠ¤íŠ¸ ì •ë³´**:
            â€¢ í…ŒìŠ¤íŠ¸ ì‹œê°„: $(TZ=Asia/Seoul date '+%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„')
            â€¢ ì €ì¥ì†Œ: ${{ github.repository }}
            â€¢ ì‹¤í–‰ì: ${{ github.actor }}
            
            ğŸ”§ **ì„¤ì • ìƒíƒœ**:
            â€¢ TELEGRAM_BOT_TOKEN: âœ… ì„¤ì •ë¨
            â€¢ TELEGRAM_CHAT_ID: âœ… ì„¤ì •ë¨
            
            ---
            ğŸ¯ ëª¨ë“  ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤!
          format: markdown

  security-alert:
    name: ğŸ›¡ï¸ ë³´ì•ˆ ì•Œë¦¼
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && contains(github.event.workflow_run.name, 'Security')
    
    steps:
      - name: ğŸ›¡ï¸ ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ì•Œë¦¼
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸ›¡ï¸ **ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ**
            
            ${{ github.event.workflow_run.conclusion == 'success' && 'âœ… **ë³´ì•ˆ ìŠ¤ìº” í†µê³¼**' || 'âŒ **ë³´ì•ˆ ì´ìŠˆ ë°œê²¬**' }}
            
            ğŸ“‹ **ìŠ¤ìº” ì •ë³´**:
            â€¢ ì›Œí¬í”Œë¡œìš°: ${{ github.event.workflow_run.name }}
            â€¢ ê²°ê³¼: ${{ github.event.workflow_run.conclusion }}
            â€¢ ë¸Œëœì¹˜: ${{ github.event.workflow_run.head_branch }}
            
            ğŸ” **ìƒì„¸ ê²°ê³¼**: 
            ${{ github.event.workflow_run.html_url }}
            
            ---
            ${{ github.event.workflow_run.conclusion == 'success' && 'ğŸ¯ ë³´ì•ˆ ìƒíƒœê°€ ì–‘í˜¸í•©ë‹ˆë‹¤!' || 'âš ï¸ ë³´ì•ˆ ì´ìŠˆë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•˜ì„¸ìš”!' }}
          format: markdown