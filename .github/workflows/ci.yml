name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'
  CI: true
  SKIP_ENV_VALIDATION: true
  
jobs:
  # ë¦°íŠ¸ ë° íƒ€ì… ì²´í¬
  lint-and-type-check:
    name: ğŸ” Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Create basic environment file
        run: |
          cp .env.example .env.local
          echo "NODE_ENV=test" >> .env.local
          
      - name: Run ESLint
        run: |
          echo "ğŸ” Running ESLint..."
          npm run lint 2>&1 | tee eslint-output.log
          
          # ESLint ê²°ê³¼ ë¶„ì„
          if grep -q "Error:" eslint-output.log; then
            ERROR_COUNT=$(grep -c "Error:" eslint-output.log || echo "0")
            echo "âŒ ESLint errors found: $ERROR_COUNT"
            echo "::error::ESLint validation failed with $ERROR_COUNT errors"
            exit 1
          else
            WARNING_COUNT=$(grep -c "Warning:" eslint-output.log || echo "0")
            echo "âœ… ESLint passed with $WARNING_COUNT warnings"
            echo "::notice::ESLint completed with $WARNING_COUNT warnings"
          fi
        
      - name: Run TypeScript check (strict)
        run: npm run type-check

  # í™˜ê²½ë³€ìˆ˜ ë³´ì•ˆ ê²€ì‚¬
  security-check:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
          
      - name: Check for hardcoded secrets
        run: |
          echo "ğŸ” Checking for hardcoded secrets..."
          if grep -r -i "sk-.*" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" app/ lib/ components/ 2>/dev/null; then
            echo "âŒ Hardcoded API keys found!"
            exit 1
          fi
          if grep -r -i "eyJ[A-Za-z0-9-_]*\.[A-Za-z0-9-_]*\.[A-Za-z0-9-_]*" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" app/ lib/ components/ 2>/dev/null; then
            echo "âŒ Hardcoded JWT tokens found!"
            exit 1
          fi
          echo "âœ… No hardcoded secrets detected"
          
      - name: Check .env.example exists
        run: |
          if [ ! -f .env.example ]; then
            echo "âŒ .env.example file is missing!"
            exit 1
          fi
          echo "âœ… .env.example file exists"

  # ë¹Œë“œ í…ŒìŠ¤íŠ¸
  build-test:
    name: ğŸ—ï¸ Build Test
    runs-on: ubuntu-latest
    needs: [lint-and-type-check]
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Create test environment file
        run: |
          # CI ì „ìš© í…ŒìŠ¤íŠ¸ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          cat > .env.local << 'EOF'
          # CI Test Environment
          NEXT_PUBLIC_SUPABASE_URL=https://ci-test.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.ci-test-anon
          SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.ci-service-role
          JWT_SECRET=ci-test-jwt-secret-for-testing-only-32chars
          ENCRYPTION_KEY=ci-test-encryption-key-for-testing-only-must-be-64-chars-long
          CRON_SECRET=ci-test-cron-secret
          NEXT_PUBLIC_APP_URL=https://ci-test.example.com
          NEXT_PUBLIC_TOSS_CLIENT_KEY=test-toss-client-key
          TOSS_SECRET_KEY=test-toss-secret-key
          GEMINI_API_KEY=test-gemini-api-key
          NODE_ENV=production
          EOF
          
      - name: Validate environment setup
        run: |
          echo "ğŸ” Validating CI environment..."
          if [ -f .env.local ]; then
            echo "âœ… Environment file created"
          else
            echo "âŒ Environment file missing"
            exit 1
          fi
          
      - name: Build application
        run: |
          echo "ğŸ—ï¸ Building application..."
          npm run build
          
      - name: Check build output
        run: |
          echo "âœ… Build completed successfully"
          if [ -d .next ]; then
            echo "ğŸ“¦ Build output:"
            ls -la .next/ || echo "Build directory structure not available"
            BUNDLE_SIZE=$(du -sm .next 2>/dev/null | cut -f1 || echo "0")
            echo "ğŸ“ Bundle size: ${BUNDLE_SIZE}MB"
          else
            echo "âŒ Build directory not found"
            exit 1
          fi

  # ë³´ì•ˆ ìŠ¤ìº”
  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”„ Cache Trivy database
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: ${{ runner.os }}-trivy-ci-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-trivy-ci-

      - name: Run Trivy vulnerability scanner (Critical/High only)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'  
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: 0
          
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  deployment-readiness:
    name: ğŸš€ Deployment Readiness
    runs-on: ubuntu-latest
    needs: [build-test, security-check]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Deployment readiness check
        run: |
          echo "ğŸ¯ Main branch deployment readiness:"
          echo "âœ… Build test passed"
          echo "âœ… Security check passed"
          echo "ğŸš€ Ready for deployment"

  # Vercel í”„ë¦¬ë·° ë°°í¬ (PRìš©)
  preview-deployment:
    name: ğŸ” Preview Deployment
    runs-on: ubuntu-latest
    needs: [build-test]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Deploy to Vercel Preview
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          scope: ${{ secrets.VERCEL_ORG_ID }}
          working-directory: ./
        if: env.HAS_VERCEL_SECRETS == 'true'
        env:
          HAS_VERCEL_SECRETS: ${{ secrets.VERCEL_TOKEN != '' }}

  # ì„±ê³µ ì•Œë¦¼
  notify-success:
    name: ğŸ“¢ CI Success
    runs-on: ubuntu-latest
    needs: [lint-and-type-check, security-check, build-test]
    if: success()
    
    steps:
      - name: Success notification
        run: |
          echo "ğŸ‰ All CI checks passed!"
          echo "âœ… Code quality: PASSED"
          echo "âœ… Security: PASSED"  
          echo "âœ… Build: PASSED"