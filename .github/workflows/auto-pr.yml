name: Auto PR Creation

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch for PR'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - staging

jobs:
  # ìë™ PR ìƒì„± (develop â†’ main)
  create-auto-pr:
    name: ğŸ¤– Auto PR Creation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Check for changes
        id: changes
        run: |
          # main ë¸Œëœì¹˜ì™€ ë¹„êµí•˜ì—¬ ë³€ê²½ì‚¬í•­ í™•ì¸
          git fetch origin main
          CHANGES=$(git log origin/main..HEAD --oneline | wc -l)
          echo "changes=$CHANGES" >> $GITHUB_OUTPUT
          
          if [ "$CHANGES" -gt 0 ]; then
            echo "ğŸ”„ $CHANGES commits ahead of main"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… No changes to merge"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ Generate PR body
        id: pr-body
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # ì»¤ë°‹ íˆìŠ¤í† ë¦¬ ê¸°ë°˜ PR ë³¸ë¬¸ ìƒì„±
          echo "## ğŸš€ ìë™ ìƒì„±ëœ PR" > pr_body.md
          echo "" >> pr_body.md
          echo "ì´ PRì€ develop ë¸Œëœì¹˜ì˜ ë³€ê²½ì‚¬í•­ì„ mainìœ¼ë¡œ ë³‘í•©í•©ë‹ˆë‹¤." >> pr_body.md
          echo "" >> pr_body.md
          echo "### ğŸ“‹ í¬í•¨ëœ ì»¤ë°‹ë“¤:" >> pr_body.md
          git log origin/main..HEAD --oneline --pretty=format:"- %s (%an)" >> pr_body.md
          echo "" >> pr_body.md
          echo "" >> pr_body.md
          echo "### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸:" >> pr_body.md
          echo "- [x] CI/CD íŒŒì´í”„ë¼ì¸ í†µê³¼" >> pr_body.md
          echo "- [x] ì½”ë“œ ë¦¬ë·° ì™„ë£Œ (develop ë¸Œëœì¹˜)" >> pr_body.md  
          echo "- [x] ë³´ì•ˆ ê²€ì‚¬ í†µê³¼" >> pr_body.md
          echo "- [ ] ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì™„ë£Œ" >> pr_body.md
          echo "" >> pr_body.md
          echo "### ğŸ¤– ìë™í™” ì •ë³´:" >> pr_body.md
          echo "- **ìƒì„± ì‹œê°„**: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')" >> pr_body.md
          echo "- **íŠ¸ë¦¬ê±°**: develop ë¸Œëœì¹˜ push" >> pr_body.md
          echo "- **ì»¤ë°‹ ìˆ˜**: ${{ steps.changes.outputs.changes }}ê°œ" >> pr_body.md
          echo "" >> pr_body.md
          echo "---" >> pr_body.md
          echo "ğŸ¤– *ì´ PRì€ GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*" >> pr_body.md

      - name: ğŸ” Check existing PR
        id: existing-pr
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # ê¸°ì¡´ open PRì´ ìˆëŠ”ì§€ í™•ì¸
          EXISTING_PR=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number' 2>/dev/null || echo "")
          
          if [ ! -z "$EXISTING_PR" ]; then
            echo "existing_pr=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "ğŸ”„ ê¸°ì¡´ PR #$EXISTING_PR ë°œê²¬"
          else
            echo "existing_pr=" >> $GITHUB_OUTPUT
            echo "âœ¨ ìƒˆ PR ìƒì„± í•„ìš”"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ Create PR
        if: steps.changes.outputs.has_changes == 'true' && steps.existing-pr.outputs.existing_pr == ''
        run: |
          gh pr create \
            --title "ğŸš€ Auto-merge develop â†’ main" \
            --body-file pr_body.md \
            --base main \
            --head develop \
            --label "auto-generated,ready-for-review" \
            --assignee "@me"
          
          echo "âœ… ìƒˆ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ Update existing PR  
        if: steps.changes.outputs.has_changes == 'true' && steps.existing-pr.outputs.existing_pr != ''
        run: |
          gh pr edit ${{ steps.existing-pr.outputs.existing_pr }} \
            --body-file pr_body.md \
            --add-label "updated"
          
          echo "âœ… ê¸°ì¡´ PR #${{ steps.existing-pr.outputs.existing_pr }}ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¢ Send notification
        if: steps.changes.outputs.has_changes == 'true' && secrets.TELEGRAM_BOT_TOKEN != ''
        run: |
          PR_NUMBER=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number' 2>/dev/null || echo "")
          PR_URL="https://github.com/${{ github.repository }}/pull/$PR_NUMBER"
          
          MESSAGE="ğŸ¤– **ìë™ PR ìƒì„±ë¨**
          
          Repository: ${{ github.repository }}
          Branch: develop â†’ main
          Commits: ${{ steps.changes.outputs.changes }}ê°œ
          
          ğŸ”— [PR í™•ì¸í•˜ê¸°]($PR_URL)
          
          â° $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=true"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ìˆ˜ë™ íŠ¸ë¦¬ê±°ëœ PR ìƒì„±
  manual-pr:
    name: ğŸ¯ Manual PR Creation  
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“ Create manual PR
        run: |
          TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
          SOURCE_BRANCH="${{ github.ref_name }}"
          
          echo "ğŸ¯ Creating PR: $SOURCE_BRANCH â†’ $TARGET_BRANCH"
          
          gh pr create \
            --title "ğŸ¯ Manual PR: $SOURCE_BRANCH â†’ $TARGET_BRANCH" \
            --body "ìˆ˜ë™ìœ¼ë¡œ ìƒì„±ëœ PRì…ë‹ˆë‹¤.
            
            **ë³€ê²½ì‚¬í•­**: $SOURCE_BRANCH ë¸Œëœì¹˜ì˜ ìµœì‹  ë³€ê²½ì‚¬í•­ì„ $TARGET_BRANCHë¡œ ë³‘í•©
            **ìƒì„±ì**: @${{ github.actor }}
            **ìƒì„± ì‹œê°„**: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')" \
            --base "$TARGET_BRANCH" \
            --head "$SOURCE_BRANCH" \
            --label "manual,ready-for-review" \
            --assignee "@me"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}