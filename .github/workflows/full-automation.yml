# ì „ì²´ ìë™í™” íŒŒì´í”„ë¼ì¸ - dduksangLAB í†µí•© ê²€ì¦
name: Full Automation Pipeline

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ ì„ íƒ'
        required: true
        default: 'full'
        type: choice
        options:
          - quick
          - full
          - custom
      agents:
        description: 'ì‹¤í–‰í•  ì—ì´ì „íŠ¸ (custom ëª¨ë“œ, ì‰¼í‘œë¡œ êµ¬ë¶„)'
        required: false
        default: 'qa,security,performance,devops'
      notification:
        description: 'Telegram ì•Œë¦¼ ì „ì†¡'
        type: boolean
        default: true

env:
  NODE_VERSION: '20'

jobs:
  # í†µí•© ìë™í™” ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  full-automation:
    name: ğŸ¤– í†µí•© ìë™í™” ì‹¤í–‰
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸš€ Execute Full Automation Workflow
        id: automation
        run: |
          # ì‹¤í–‰ ëª¨ë“œ ì„¤ì •
          MODE="${{ github.event.inputs.mode }}"
          AGENTS="${{ github.event.inputs.agents }}"
          
          echo "ğŸ¤– ì‹¤í–‰ ëª¨ë“œ: $MODE"
          echo "ğŸ”§ ëŒ€ìƒ ì—ì´ì „íŠ¸: ${AGENTS:-'all'}"
          
          # ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
          if [ "$MODE" = "custom" ] && [ ! -z "$AGENTS" ]; then
            npm run automation:workflow custom -- --agents="$AGENTS"
          elif [ "$MODE" = "quick" ]; then
            npm run automation:workflow:quick
          else
            npm run automation:workflow:full
          fi
        env:
          # í…ŒìŠ¤íŠ¸ í™˜ê²½ë³€ìˆ˜
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_TOSS_CLIENT_KEY: ${{ secrets.NEXT_PUBLIC_TOSS_CLIENT_KEY }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          TOSS_SECRET_KEY: ${{ secrets.TOSS_SECRET_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
        continue-on-error: false

      - name: ğŸ“Š Upload Automation Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: automation-reports
          path: |
            workflow-reports/
            security-reports/
            performance-reports/
          retention-days: 7

      - name: ğŸ“¨ Send Success Notification
        if: success() && github.event.inputs.notification == 'true'
        run: |
          if [ ! -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ ! -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            MESSAGE="âœ… **dduksangLAB ì „ì²´ ìë™í™” ì„±ê³µ**
            
            ğŸš€ **ì‹¤í–‰ ì •ë³´:**
            â€¢ ëª¨ë“œ: ${{ github.event.inputs.mode }}
            â€¢ ë¸Œëœì¹˜: ${{ github.ref_name }}
            â€¢ ì»¤ë°‹: ${{ github.sha }}
            
            ğŸ‘¤ **ì‹¤í–‰ì:** ${{ github.actor }}
            â° **ì‹œê°„:** $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')
            
            ğŸ”— [ìƒì„¸ ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ğŸ‰ ëª¨ë“  ìë™í™” ê²€ì¦ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d "text=$MESSAGE" \
              -d "parse_mode=Markdown" \
              -d "disable_web_page_preview=true"
          fi

      - name: ğŸ“¨ Send Failure Notification
        if: failure() && github.event.inputs.notification == 'true'
        run: |
          if [ ! -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ ! -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            MESSAGE="âŒ **dduksangLAB ìë™í™” ì‹¤íŒ¨**
            
            ğŸš¨ **ì‹¤í–‰ ì •ë³´:**
            â€¢ ëª¨ë“œ: ${{ github.event.inputs.mode }}
            â€¢ ë¸Œëœì¹˜: ${{ github.ref_name }}
            â€¢ ì»¤ë°‹: ${{ github.sha }}
            
            ğŸ‘¤ **ì‹¤í–‰ì:** ${{ github.actor }}
            â° **ì‹œê°„:** $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')
            
            ğŸ”— [ì˜¤ë¥˜ ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            âš ï¸ ìë™í™” ê²€ì¦ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
            
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d "text=$MESSAGE" \
              -d "parse_mode=Markdown" \
              -d "disable_web_page_preview=true"
          fi

  # ì•¼ê°„ ìë™ ì‹¤í–‰ (ë§¤ì¼ ìƒˆë²½ 2ì‹œ)
  nightly-automation:
    name: ğŸŒ™ ì•¼ê°„ ìë™ ê²€ì¦
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸŒ™ Run Nightly Full Automation
        run: npm run automation:workflow:full
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_TOSS_CLIENT_KEY: ${{ secrets.NEXT_PUBLIC_TOSS_CLIENT_KEY }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          TOSS_SECRET_KEY: ${{ secrets.TOSS_SECRET_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}

      - name: ğŸ“Š Upload Nightly Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-automation-reports
          path: |
            workflow-reports/
            security-reports/  
            performance-reports/
          retention-days: 30

# ë§¤ì¼ ìƒˆë²½ 2ì‹œì— ìë™ ì‹¤í–‰
on:
  schedule:
    - cron: '0 2 * * *'  # ë§¤ì¼ ìƒˆë²½ 2ì‹œ (UTC)